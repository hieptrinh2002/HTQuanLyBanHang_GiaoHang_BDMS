----------------------------------DATABASE----------------------------------

CREATE DATABASE Ql_DATHANG_BANHANG_HQTCSDL
GO
USE Ql_DATHANG_BANHANG_HQTCSDL
GO

CREATE TABLE CUAHANG(
    MA_CUA_HANG CHAR(5) NOT NULL,
	TEN_CUA_HANG NVARCHAR(255),
	EMAIL CHAR(100),
	THANH_PHO NVARCHAR(255),
	QUAN NVARCHAR(255),
	SDT CHAR(10),
	SO_CHI_NHANH INT,
	NGUOI_DAI_DIEN NVARCHAR(50),-- tên người đại diện 
	MA_SO_THUE CHAR(5),
	ID_TAI_KHOAN INT
	PRIMARY KEY (MA_CUA_HANG)
)
GO 

CREATE TABLE HOPDONG(
    MA_HOP_DONG CHAR(5) NOT NULL,
	NGAY_TAO  DATETIME,
	TG_BAT_DAU DATETIME,
	TG_KET_THUC DATETIME,
	MA_CUA_HANG CHAR(5),--khóa ngoại
	STK CHAR(12),--khóa ngoại
	MA_NHAN_VIEN CHAR(5), -- NHÂN VIÊN PHÊ DUYỆT HỢP ĐỒNG 
	TRANG_THAI INT DEFAULT 0, -- 0 : chưa duyệt, 1 NV ĐÃ DUYỆT, 2 đã xóa 
	PRIMARY KEY (MA_HOP_DONG)
)

GO
ALTER TABLE HOPDONG ADD CONSTRAINT C_TRANGTHAI_HOPDONG CHECK(TRANG_THAI IN (0,1,2))


CREATE TABLE TKNGANHANG(
    STK CHAR(12) NOT NULL,
	TEN_NGAN_HANG NVARCHAR(255),
	CHI_NHANH NVARCHAR(255),
	DIA_CHI NVARCHAR(255),
	PRIMARY KEY (STK)
)

GO

CREATE TABLE CHINHANH(
    MA_CHI_NHANH CHAR(5) NOT NULL,
	SL_DON_MOINGAY INT,
	DIA_CHI NVARCHAR(255),
	SDT NVARCHAR(10),
	TINH_TRANG NVARCHAR(255) DEFAULT N'bình thường',
	MA_CUA_HANG CHAR(5),
	MA_HOP_DONG CHAR(5),
	KHUVUC NVARCHAR(255)
	PRIMARY KEY (MA_CHI_NHANH)
)
GO
ALTER TABLE CHINHANH ADD CONSTRAINT C_TINH_TRANG_CHINHANH CHECK(TINH_TRANG IN (N'bình thường',N'tạm nghỉ'))

GO
CREATE TABLE DONDATHANG(
	MA_DON CHAR(5) NOT NULL,
	TONG_TIEN FLOAT,
	DIA_CHI NVARCHAR(255),
	TINH_TRANG NVARCHAR(255) DEFAULT N'chờ xác nhận',
	PHI_VAN_CHUYEN FLOAT,
	MA_KHACH_HANG CHAR(5),
	MA_TAI_XE CHAR(5),
	MA_CHI_NHANH CHAR(5),
	TRANG_THAI INT DEFAULT 1, -- 0: ĐÃ XÓA , 1: TỒN TẠI 
	PRIMARY KEY(MA_DON)
)
ALTER TABLE DONDATHANG ADD CONSTRAINT C_TRANGTHAI_DONDATHNAG CHECK(TRANG_THAI IN (0,1))
ALTER TABLE DONDATHANG ADD CONSTRAINT C_TINH_TRANG_DONDATHNAG CHECK(TINH_TRANG IN(N'chờ xác nhận',N'đã xác nhận',N'đang giao',N'đã giao',N'đã hủy'))
GO

CREATE TABLE THUCDON(
	MA_THUC_DON CHAR(5) NOT NULL,
	TEN_THUC_DON NVARCHAR(255),
	TINH_TRANG NVARCHAR(255),
	MA_CUA_HANG CHAR(5),
	TRANG_THAI INT DEFAULT 1 ,-- 0: ĐÃ BỊ XÓA , 1 VẪN CÒN
	PRIMARY KEY(MA_THUC_DON)
)
GO
ALTER TABLE THUCDON ADD CONSTRAINT C_TRANGTHAI_THUCDON CHECK(TRANG_THAI IN (0,1))
GO

CREATE TABLE THUCDON_MONAN(
	MA_THUC_DON CHAR(5) NOT NULL,
	MA_MON_AN CHAR(5) NOT NULL
	PRIMARY KEY(MA_THUC_DON,MA_MON_AN)
)

GO
CREATE TABLE MON_AN (
	MA_MON_AN CHAR(5) NOT NULL,
	TEN_MON NVARCHAR(81) NOT NULL,
	TINH_TRANG NVARCHAR(255) DEFAULT N'có bán',--N'có bán',N'hết hàng hôm nay',N'tạm ngưng'
	DON_GIA FLOAT,
	MA_CUA_HANG CHAR(5),
	TRANG_THAI INT DEFAULT 1, -- 0: ĐÃ XÓA , 1: TỒN TẠI 
	PRIMARY KEY(MA_MON_AN)
)
GO
ALTER TABLE MON_AN ADD CONSTRAINT C_TINHTRANG_MONAN CHECK( TINH_TRANG IN (N'có bán',N'hết hàng hôm nay',N'tạm ngưng')) 
ALTER TABLE MON_AN ADD CONSTRAINT C_TRANGTHAI CHECK(TRANG_THAI IN (0,1))
GO

CREATE TABLE MON_AN_CHI_NHANH (
	MA_MON_AN CHAR(5) NOT NULL,
	MA_CHI_NHANH CHAR(5),
	SO_LUONG INT,
	PRIMARY KEY (MA_MON_AN,MA_CHI_NHANH)
)
GO

CREATE TABLE TUYCHON(
	MA_MON_AN CHAR(5) NOT NULL,
	TEN_TUY_CHON VARCHAR(255) NOT NULL,
	PRIMARY KEY(MA_MON_AN,TEN_TUY_CHON)
)

GO
CREATE TABLE CHITIET_DONHANG(
	MA_DON CHAR(5)NOT NULL,
	MA_MON_AN CHAR(5) NOT NULL,
	SO_LUONG INT ,
	TONG_TIEN FLOAT,
	PRIMARY KEY(MA_DON,MA_MON_AN)
)

GO

CREATE TABLE TAIXE(
	MA_TAI_XE CHAR(5) NOT NULL,
	HOTEN VARCHAR(255),
	SDT CHAR(10),
	BIEN_SO CHAR(10),
	CMND CHAR(10),
	MA_THUE CHAR(5),
	EMAIL CHAR(100),
	KHU_VUC NVARCHAR(255),
	TRANG_THAI NVARCHAR(50),
	STK CHAR(12),
	ID_TAI_KHOAN INT
	PRIMARY KEY(MA_TAI_XE)
)

GO
CREATE TABLE KHACHHANG (
	MA_KHACH_HANG CHAR(5) NOT NULL,
	HOTEN NVARCHAR(255),
	DIACHI NVARCHAR(255),
	SDT CHAR(10),
	EMAIL NVARCHAR(100),
	ID_TAI_KHOAN INT,
	PRIMARY KEY(MA_KHACH_HANG)
)
GO

CREATE TABLE TAIKHOAN ( 
	ID_TAI_KHOAN INT NOT NULL,
	TEN_DANG_NHAP NVARCHAR(255) NOT NULL,
	MAT_KHAU CHAR(100) NOT NULL,
	LOAI_TK INT DEFAULT 0, --0: ĐỐI TÁC , 1: KHÁCH HÀNG , 2: TÀI XẾ , 3: NHÂN VIÊN , 4: ADMIN
	TRANG_THAI INT DEFAULT 1, --0: BỊ KHÓA 1: ĐANG SỬ DỤNG 2: ĐÃ XÓA 
	PRIMARY KEY(ID_TAI_KHOAN),
	UNIQUE (TEN_DANG_NHAP)
)
CREATE TABLE NHANVIEN( 
	MA_NHAN_VIEN CHAR(5)NOT NULL,
	TEN_NHAN_VIEN NVARCHAR(255) NOT NULL,
	DIA_CHI NVARCHAR(255),
	SDT CHAR(10),
	ID_TAI_KHOAN INT,
	GMAIL CHAR(100),
	PRIMARY KEY(MA_NHAN_VIEN)
)
GO

INSERT INTO TAIKHOAN(ID_TAI_KHOAN,TEN_DANG_NHAP,MAT_KHAU,LOAI_TK,TRANG_THAI)
VALUES(1,'KFCTEST','1234',0,1),
		(2,'TEST','1243',0,1),
		(3,'HOANGDAT','4321',0,1),
		(4,'TEST001','1111',1,1),
		(5,'TEST002','1111',1,1),
		(6,'TEST003','1111',1,1),
		(7,'MORAX','333',3,1),
		(8,'EI','444',3,1),
		(9,'THAOTHAN','555',3,1),
		(10,'ADM1','666',4,1),
		(11,'ADM2','777',4,1),
		(12,'ADM3','888',4,1),
		(13,'TX001','666',2,1),
		(14,'TX002','777',2,1),
		(15,'TX003','888',2,1)
INSERT INTO TAIKHOAN(ID_TAI_KHOAN,TEN_DANG_NHAP,MAT_KHAU,LOAI_TK,TRANG_THAI)
VALUES(16,'KFCTEST_nvc','1234',0,1),
		(17,'NHIW','1243',0,1),
		(18,'HO HHUY HU','4321',0,1)
GO
INSERT INTO NHANVIEN(MA_NHAN_VIEN,TEN_NHAN_VIEN,DIA_CHI,SDT,ID_TAI_KHOAN,GMAIL)
VALUES ('NV001','ZHONGLI1','LIYUE1','0977420655',7,'MORAX1@GMAIL.COM'),
      ('NV002','ZHONGLI2','LIYUE2','0977220655',8,'MORAX2@GMAIL.COM'),
      ('NV003','ZHONGLI3','LIYUE3','0977620655',9,'MORAX3@GMAIL.COM')
      
GO						
INSERT INTO KHACHHANG(MA_KHACH_HANG,HOTEN,DIACHI,SDT,EMAIL,ID_TAI_KHOAN)
VALUES('KH001',N'TRỊNH HỮU HIỆP',N'45 TÂN LẬP','113','HUUHIEP@GMAIL.COM',4),
		('KH002',N'NGUYỄN NHẬT TRƯỜNG',N'45 TÂN LẬP','114','NHATTRUONG@GMAIL.COM',5),
		('KH003',N'NGUYỄN THỊ HỒNG NHUNG','KTX KHU B','115','NHUNG@GMAIL.COM',6)
GO
INSERT INTO TKNGANHANG(STK,TEN_NGAN_HANG,CHI_NHANH,DIA_CHI)
VALUES('1012647838','VCB','TPHCM',N'ĐƯỜNG ABC'),
('1012647839','VCB','TPHCM',N'ĐƯỜNG DEF'),
('1012647840','VCB','TPHCM',N'ĐƯỜNG GHI'),
('1012847839','VCB','TPHCM',N'ĐƯỜNG JKL'),
('1012847899','VCB','TPHCM',N'ĐƯỜNG MNO'),
('1012847869','VCB','TPHCM',N'ĐƯỜNG PQR')

INSERT INTO TAIXE(MA_TAI_XE,HOTEN,SDT,BIEN_SO,CMND,MA_THUE,EMAIL,KHU_VUC,TRANG_THAI,STK,ID_TAI_KHOAN)
VALUES('TX001','AETHER','666','76','212900023','MT004','AETHER@GMAIL.COM',N'TPHCM',NULL,'1012847839',13),
		('TX002','LUMIE','777','77','212900024','MT005','LUMIE@GMAIL.COM',N'BÌNH DƯƠNG',NULL,'1012847899',14),
		('TX003','KAZUHA','888','78','212900025','MT006','KAZUHA@GMAIL.COM',N'BÌNH DƯƠNG',NULL,'1012847869',15)
GO
INSERT INTO HOPDONG(MA_HOP_DONG,NGAY_TAO,TG_BAT_DAU,TG_KET_THUC,MA_CUA_HANG,STK,MA_NHAN_VIEN,TRANG_THAI)
VALUES('HD001','2018/01/01','2018/01/02','2023/01/02','CH001','1012647838','NV001',1),
	('HD002','2017/07/01','2017/09/01','2025/09/01','CH002','1012647839','NV002',1),
	('HD003','2022/01/01','2022/01/02','2022/11/11','CH003','1012647840','NV003',1)
INSERT INTO HOPDONG(MA_HOP_DONG,NGAY_TAO,TG_BAT_DAU,TG_KET_THUC,MA_CUA_HANG,STK,MA_NHAN_VIEN,TRANG_THAI)
VALUES('HD004','2018/01/01','2025/01/02','2023/01/02','CH003','1012647838','NV001',0),
	('HD006','2016/07/01','2023/09/01','2025/09/01','CH002','1012647839','NV002',0),
	('HD005','2021/01/01','2026/01/02','2022/11/11','CH001','1012647840','NV003',0)
INSERT INTO HOPDONG(MA_HOP_DONG,NGAY_TAO,TG_BAT_DAU,TG_KET_THUC,MA_CUA_HANG,STK,MA_NHAN_VIEN,TRANG_THAI)
VALUES ('HD007','2019/07/01','2026/09/01','2025/09/01','CH004','1012647839','NV002',1),
	('HD008','2015/01/01','2028/01/02','2022/11/11','CH007','1012647840','NV003',0)
GO
INSERT INTO CUAHANG(MA_CUA_HANG,TEN_CUA_HANG,EMAIL,THANH_PHO,QUAN,SDT,SO_CHI_NHANH,NGUOI_DAI_DIEN,MA_SO_THUE,ID_TAI_KHOAN)
VALUES  ('CH001',N'KFC','KFC@GMAIL.COM','TPHCM',N'QUẬN 5','1012647838',2,'RONALDO','MT001',1),
		('CH002','TEST','TEST@GMAIL.COM',N'DĨ AN',N'ĐÔNG HÒA','1012647838',2,'MESSI','TEST',2),
		('CH003',N'LẨU CHAY','HOANGDAT@GMAIL.COM',N'DĨ AN',N'ĐÔNG HÒA','1012647838',3,'BACKHAM','MT003',3)
INSERT INTO CUAHANG(MA_CUA_HANG,TEN_CUA_HANG,EMAIL,THANH_PHO,QUAN,SDT,SO_CHI_NHANH,NGUOI_DAI_DIEN,MA_SO_THUE,ID_TAI_KHOAN)
VALUES  ('CH004','KFC','KFC@GMAIL.COM','TPHCM',N'QUẬN 5','1012647838',2,'RONALDO','MT001',16),
		('CH006','TEST123','TEST@GMAIL.COM',N'DĨ AN',N'ĐÔNG HÒA','1012647838',2,'Benzema','TEST',17),
		('CH007',N'LẨU CHAY ABC','HOANGDAT@GMAIL.COM',N'DĨ AN',N'ĐÔNG HÒA','1012647838',3,'ANTONY','MT003',18)

GO
INSERT INTO MON_AN(MA_MON_AN,TEN_MON,TINH_TRANG,DON_GIA,MA_CUA_HANG,TRANG_THAI)
VALUES('MA004','Gà rán',N'có bán',100000,'CH001',1),
		('MA005','Khoai tây chiên',N'có bán',30000,'CH001',1),
		('MA006','Mì ý',N'có bán',500000,'CH001',1),
		('MA007','Combo Gà + Mì ý',N'có bán',140000,'CH001',1),
		('MA008','Combo 3 người',N'có bán',200000,'CH001',1),
		('MA009','Gà rán cay',N'có bán',100000,'CH001',1),
		('MA001','TEST',N'có bán',100000,'CH001',1),
		('MA002','TEST2',N'có bán',110000,'CH002',1),
		('MA003','TEST3',N'có bán',200000,'CH003',1)
GO

INSERT INTO CHINHANH(MA_CHI_NHANH,SL_DON_MOINGAY,DIA_CHI,SDT,TINH_TRANG,MA_CUA_HANG,MA_HOP_DONG,KHUVUC)
VALUES('CN001',100,N'227 NGUYỄN VĂN CỪ','090505005',NULL,'CH001','HD001',N'TPHCM'),
		('CN002',90,N'1 NGUYỄN THỊ MINH KHAI ','0987654321',NULL,'CH001','HD001','TPHCM'),
		('CN003',110,N'227 NGUYỄN VĂN LINH','095505005',NULL,'CH002','HD002',N'BÌNH DƯƠNG'),
		('CN004',120,N'22 TRƯỜNG CHINH','090555005',NULL,'CH002','HD002',N'BÌNH DƯƠNG'),
		('CN005',130,N'ĐƯỜNG VÀNH ĐAI','090507005',NULL,'CH003','HD003',N'BÌNH DƯƠNG'),
		('CN006',140,N'ĐƯỜNG SỐ 8','090505345',NULL,'CH003','HD003',N'BÌNH DƯƠNG'),
		('CN007',150,N'SAU KTX KHU B ĐHQG','090505567',NULL,'CH003','HD003',N'BÌNH DƯƠNG')
GO
INSERT INTO MON_AN_CHI_NHANH VALUES ('MA003','CN001',100),
									('MA004','CN002',100), ('MA005','CN002',100), ('MA006','CN001',100), ('MA007','CN002',100), ('MA008','CN001',100), ('MA009','CN002',100),
									('MA001','CN001',100),
									('MA002','CN002',100)


GO
INSERT INTO DONDATHANG(MA_DON,TONG_TIEN,DIA_CHI,TINH_TRANG,PHI_VAN_CHUYEN,MA_KHACH_HANG,MA_TAI_XE,MA_CHI_NHANH,TRANG_THAI)
VALUES('DH001',NULL,N'45 TÂN LẬP',NULL,30000,'KH001','TX001','CN003',1),
		('DH002',NULL,N'45 TÂN LẬP',NULL,40000,'KH002','TX002','CN001',1),
		('DH003',NULL,N'45 TÂN LẬP',NULL,30000,'KH002','TX003','CN007',1)


GO

-- KHÓA NGOẠI
ALTER TABLE HOPDONG ADD CONSTRAINT FK_HOPDONG_CUAHANG
	FOREIGN KEY (MA_CUA_HANG) REFERENCES CUAHANG(MA_CUA_HANG)
GO
ALTER TABLE HOPDONG ADD CONSTRAINT FK_HOPDONG_TKNGANHANG
	FOREIGN KEY (STK) REFERENCES TKNGANHANG(STK)
GO
ALTER TABLE HOPDONG ADD CONSTRAINT FK_HOPDONG_NHANVIEN  
	FOREIGN KEY (MA_NHAN_VIEN) REFERENCES NHANVIEN(MA_NHAN_VIEN)
GO
ALTER TABLE TAIXE ADD CONSTRAINT FK_TAIXE_TKNGANHANG
	FOREIGN KEY (STK) REFERENCES TKNGANHANG(STK)

---- KHÓA NGOẠI ĐẾN TÀI KHOẢN (KHÁCH HÀNG , NHÂN VIÊN , CỬA HÀNG , TÀI XẾ ) 
ALTER TABLE KHACHHANG ADD CONSTRAINT FK_KHACHHANG_TAIKHOAN
	FOREIGN KEY (ID_TAI_KHOAN) REFERENCES TAIKHOAN(ID_TAI_KHOAN)
GO
ALTER TABLE NHANVIEN ADD CONSTRAINT FK_NHANVIEN_TAIKHOAN
	FOREIGN KEY (ID_TAI_KHOAN) REFERENCES TAIKHOAN(ID_TAI_KHOAN)
GO
ALTER TABLE CUAHANG ADD CONSTRAINT FK_CUAHANG_TAIKHOAN
	FOREIGN KEY (ID_TAI_KHOAN) REFERENCES TAIKHOAN(ID_TAI_KHOAN)
GO
ALTER TABLE TAIXE ADD CONSTRAINT FK_TAIXE_TAIKHOAN
	FOREIGN KEY (ID_TAI_KHOAN) REFERENCES TAIKHOAN(ID_TAI_KHOAN)

----------------------------------------------------------------------------------
GO
ALTER TABLE CHINHANH ADD CONSTRAINT FK_CHINHANH_CUAHANG
	FOREIGN KEY (MA_CUA_HANG) REFERENCES CUAHANG(MA_CUA_HANG)

GO 
ALTER TABLE CHINHANH ADD CONSTRAINT FK_CHINHANH_HOPDONG
	FOREIGN KEY (MA_HOP_DONG) REFERENCES HOPDONG(MA_HOP_DONG)
GO
ALTER TABLE DONDATHANG ADD CONSTRAINT FK_DONDATHANG_CHINHANH
	FOREIGN KEY (MA_CHI_NHANH) REFERENCES CHINHANH(MA_CHI_NHANH) 
GO
ALTER TABLE DONDATHANG ADD CONSTRAINT FK_DONDATHANG_TAIXE
	FOREIGN KEY (MA_TAI_XE) REFERENCES TAIXE(MA_TAI_XE) 
GO
ALTER TABLE DONDATHANG ADD CONSTRAINT FK_DONDATHANG_KHACHHANG
	FOREIGN KEY (MA_KHACH_HANG) REFERENCES KHACHHANG(MA_KHACH_HANG) 


GO
ALTER TABLE CHITIET_DONHANG ADD CONSTRAINT FK_CHITIET_DONHANG_DONDATHANG
	FOREIGN KEY (MA_DON) REFERENCES DONDATHANG(MA_DON)
GO
ALTER TABLE CHITIET_DONHANG ADD CONSTRAINT FK_CHITIET_DONHANG_MON_AN
	FOREIGN KEY (MA_MON_AN) REFERENCES MON_AN(MA_MON_AN)

GO
ALTER TABLE TUYCHON ADD CONSTRAINT FK_TUYCHON_MON_AN
	FOREIGN KEY (MA_MON_AN) REFERENCES MON_AN(MA_MON_AN)

GO
ALTER TABLE MON_AN ADD CONSTRAINT FK_MON_AN_CUAHANG 
	FOREIGN KEY (MA_CUA_HANG) REFERENCES CUAHANG(MA_CUA_HANG)

GO
ALTER TABLE THUCDON ADD CONSTRAINT FK_THUCDON_CUAHANG
	FOREIGN KEY (MA_CUA_HANG) REFERENCES CUAHANG(MA_CUA_HANG)
GO
ALTER TABLE THUCDON_MONAN ADD CONSTRAINT FK_THUCDON_MONAN_THUCDON
	FOREIGN KEY (MA_THUC_DON) REFERENCES THUCDON(MA_THUC_DON)
GO
ALTER TABLE THUCDON_MONAN ADD CONSTRAINT FK_THUCDON_MONAN_MON_AN
	FOREIGN KEY (MA_MON_AN) REFERENCES MON_AN(MA_MON_AN)

GO
ALTER TABLE MON_AN_CHI_NHANH ADD CONSTRAINT FK_MON_AN_CHI_NHANH_CHINHANH
	FOREIGN KEY (MA_CHI_NHANH) REFERENCES CHINHANH(MA_CHI_NHANH)
ALTER TABLE MON_AN_CHI_NHANH ADD CONSTRAINT FK_MON_AN_CHI_NHANH_MON_AN
	FOREIGN KEY (MA_MON_AN) REFERENCES MON_AN(MA_MON_AN)


